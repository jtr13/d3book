# Interactivity <i class="fas fa-mouse-pointer"></i>

Read: *IDVW2*, Chapter 10 Interactivity

<script src="https://d3js.org/d3.v7.js"></script>

## Lecture slides <i class="fa fa-television"></i>

[Interactivity](pdfs/interactivity.pdf){target="_blank"}

## Event listeners

```{r, echo=FALSE, eval=!HTML, out.width='33%'}
webshot::webshot("https://jtr13.github.io/d3book/interactivity.html", selector = "svg")
```

One of the main reason that we choose D3 is its potential to create interactive graphs. In this chapter, we will explain basic concepts and present some interesting interactivity graphs. For demonstrating purpose, all the interaction will be reflected in the following graph. When going through sections, read the script first before executing it in the console. 

<center>
```{asis, echo=HTML}
<svg width="500" height="400">
  <rect width="500" height="400" fill="lightblue"></rect>
  <text x="300" y="20"></text>
  <circle cx="50" cy="40" r="20" fill="blue"></circle>
  <circle cx="100" cy="80" r="30" fill="blue"></circle>
  <circle cx="200" cy="160" r="45" fill="blue"></circle>
  <circle cx="350" cy="280" r="67.5" fill="blue"></circle>
</svg>
```  
</center>

**Note:** there is an empty `<text>` field in the graph.

**Note:** event management [changed in v6](https://observablehq.com/@d3/d3v6-migration-guide#events){target="_blank"} so code written for earlier versions of D3 will not work. 

### Basics

To create an interaction, we should consider three questions: What is the user event? What is the receiver of the event? What happens when the event is triggered? Consider the following script and think about the questions in all subsections.

``` js
d3.select("svg").selectAll("circle")
  .on("click", function () {
    d3.select("svg").select("text")
      .text("You clicked on a circle!");
        });
```

* What is the user event? **Clicking**
* What is the receiver of the event? **All circles**
* What happens when the event is triggered? **Change the text to "You clicked on a circle!"**

Generally, **user events** are any [DOM event type](https://developer.mozilla.org/en-US/docs/Web/Events#Standard_events). We will focus on mouse events, for example: "click","mouseover",and "mouseout" and they are specified in `.on()`. **Receivers of the event** is the element that you want to bind the event listener and they are specified in the first selection arguments. Lastly, what happens after you trigger the events is the **change** you want to reflect. There are a variety of things you can do and we will introduce some below.

**Note:** in the above example, we do not need any information of the circles (attributes, data, etc.)

#### Add an element

``` js
d3.select("svg")
  .on("click", function(event) {
    var coord = d3.pointer(event)
    d3.select(this)
      .append("circle")
        .attr("cx",coord[0])
        .attr("cy",coord[1])
        .attr("r","2")
        .attr("fill", "red");
      });
```

Starting with the basic, you can add an element onto the svg. After executing the script, you can add a circle at where you click.

In this script:

* What is the user event? **Clicking**
* What is the receiver of the event? **The svg element**
* What happens when the event is triggered? **Add a red circle of radius 2 at wherever you click**

**Note:** `d3.pointer()` will be explained later

#### Change an attribute value

``` js
d3.select("svg").selectAll("circle")
  .on("click", function(event) {
    d3.select(this)
      .attr("fill", "red");
      });
```

You can change the attribute value of an element. In this case, circles will turn red if you click on it. Comparing with the first example, since you are changing the color of the circles you click, you will need to know which circle you click. 

In this script:

* What is the user event? **Clicking**
* What is the receiver of the event? **All circles**
* What happens when the event is triggered? **Change the circle you click to red**

**Note:** in the context of event handlers, "this" is the element that received the event, a.k.a. what you clicked on if it's a click event (In this case the red line). An alternative ($\geq$ v6, see link above) is to pass the event and access the element with `event.currentTarget`:

``` js
d3.select("svg").selectAll("circle")
  .on("click", function(event) {
    d3.select(event.currentTarget)
      .attr("fill", "red");
      });
```

#### Get attribute value 

``` js
d3.select("svg").selectAll("circle")
  .on("click", function(event) {
  const rad = d3.select(event.currentTarget).attr("r");
  d3.select("svg").select("text")
    .text(`The radius is ${rad} pixels.`);
    });
```  

You can retrieve the attribute value of an element. In this case, we retrieve the radius of circles and show it on the svg.

In this script:

* What is the user event? **Clicking**
* What is the receiver of the event? **All circles**
* What happens when the event is triggered? **Retrieve the radius of the circle you click and show it on the svg element** (Note in this case we have multiple changes)

#### Change attribute using bounded data

``` js
d3.select("svg").selectAll("circle")
  .data([5,40,20,60])
  .on("click", function(event, d) {
    d3.select(event.currentTarget) 
      .attr("r", d)
      });

```
You can change an attribute using bounded data. In this case, every circle will have a data bounded to it.

In this script:

* What is the user event? **Clicking**
* What is the receiver of the event? **All circles**
* What happens when the event is triggered? **Change the radius of the circle you click according to bounded data** 

**Note:** starting with v6, the data is the 2nd parameter to be passed: `function(event, d)`. In addition, you do not need to pass `d` again when accessing the data: for example we use `d` not `d => d`.


#### Get the location of the event

``` js
d3.select("svg")
  .on("click", function(event) {
    d3.select("text")
      .text(`(${d3.pointer(event).map(Math.round)})`)
      });
```

We can use `d3.pointer(event)` to retreive the location of you mouse upon clicking. It returns an array of two elements (x,y coordinates).

**Note:** starting with v6, d3.mouse() was removed and replaced with d3.pointer().

``` js
d3.select("svg")
  .on("click", function (event) {
    console.log(d3.pointer(event).map(Math.round));
    });
``` 

In the second script, the location of a click is shown in the console.

#### Change the value of a radio button

The following sections involve dealing with html elements like radio button.

<p id="color" style="background-color: silver; color: white;">Please select your favorite primary color:</p>
<input type="radio" id="html" name="fav_color" value="red"> red
<input type="radio" id="css" name="fav_color" value="blue"> blue
<input type="radio" id="javascript" name="fav_color" value="yellow"> yellow

``` js
d3.selectAll("input")
  .on("click", function(event) {
    var favcolor = event.currentTarget.value;
    d3.select("p#color").style("color", favcolor);
    });
```  

<script>
d3.selectAll("input")
  .on("click", function(event) {
    const favcolor = event.currentTarget.value;
    d3.select("p#color").style("color", favcolor);
    });
</script>	

#### Separating the function and event listener

We can also write a function and event listener separately to improve readability. For example, try the following in the console:

``` js
function goyellow() {
  d3.select(this)
    .attr("fill", "yellow")
    };
```

``` js
d3.select("circle")
  .on("mouseover", goyellow);
```

### Exercise <i class="fas fa-dumbbell"></i>: Functions

In this exercise, we will create a vertical bar chart with "buttons" to add or remove bars.

You can start with a vertical bar plot with general update patterns.

Hint: use HTML paragraphs as buttons

``` html
<p id="add">Add an element</p>
<p id="remove_left">Remove bar (left)</p>
<p id="remove_right">Remove bar (right)</p>
```

[solution](code/vertical_bar.html){target="_blank"}

JavaScript:

``` js
d3.selectAll("p")
    .on("click", function () {
      const paraID = d3.select(this).attr("id");
      if (paraID == "add") {
          const newvalue = Math.floor(Math.random()*400);
          bardata.push(newvalue);
          } else if (paraID == "remove_left") {
          bardata.shift();
          } else {
          bardata.pop();
          };
      update(bardata);
      });
```

## Putting it all together

Vertical bar chart with add / remove buttons and general update pattern

## Dependent event listeners

In the following examples, the behavior or existence of one event listener depends on another.

### Global variable example

Here the circle click behavior depends on the value of the radio button: if the "Move left" radio button is checked, the circle will move left *when clicked*. If the "Move right" radio button is checked, the circle will move right *when clicked*.

A global variable is used to keep track of the radio button value. The event listener on the circle conditions the behavior on the value of this global variable.

```{r, echo=FALSE, eval=!HTML, out.width='33%'}
webshot::webshot("https://jtr13.github.io/d3book/interactivity.html#global-variable-example", selector = "#rad")
```

```{asis, echo=HTML}
<div id="rad" style="margin-left: 30px">
<h4>Click the circle.</h4>
<input type="radio" name="direction" value="left" checked="true">&nbsp;Move left
<input type="radio" name="direction" value="right">&nbsp;Move right<br>
<svg id='radio' width='300' height='200'>
  <rect x='0' y='0' width='300' height ='200' fill = 'lightblue'></rect>
  <circle cx='150' cy='100' r='20' fill='red'></circle>
  <text x='10' y='190' style = 'font-size: 80%;'>svg#radio</text>
</svg>
</div>  
```
  

<div style="margin-left: 30px">
```{js}
// global variable keeps track of which radio button is clicked
let action = "left";
d3.select("div#rad")
  .selectAll("input")
  .on("click", function() { action = d3.select(this).node().value; });
	  
// circle click behavior depends on value of "action"
d3.select("svg#radio").select("circle")
  .on("click", function () {
    let cx_new;
    if (action == "left") {
      cx_new = +d3.select(this).attr("cx") - 50;
      if (cx_new < 20) cx_new = 20;
      } else {
      cx_new = +d3.select(this).attr("cx") + 50;
      if (cx_new > 280) cx_new = 280;
      }
    d3.select(this)
      .transition()
      .duration(500)
      .attr("cx", cx_new);
      });

```
</div>


### Turn off event listener

In this example, the event listeners on the squares are turned on or off depending on the value of the radio button. Event listeners can be removed by setting the behavior to `null`.

```{r, echo=FALSE, eval=!HTML, out.width='33%'}
webshot::webshot("https://jtr13.github.io/d3book/interactivity.html#turn-off-event-listener", selector = "#rad2")
```

```{asis, echo=knitr::is_html_output()}
<div id="rad2" style="margin-left: 30px">
<h4>Click a square.</h4>
<input type="radio" name="square" value="red" checked="true">&nbsp;Red active
<input type="radio" name="square" value="blue">&nbsp;Blue active<br>

<svg id='radio2' width='300' height='200'>
  <rect x='0' y='0' width='300' height ='200' fill = 'lightblue'></rect>
  <rect id='red' x='75' y='75' width='50' height='50' fill='red'></rect>
  <rect id='blue' x='175' y='75' width='50' height='50' fill='blue'></rect>
  <text x='10' y='190' style = 'font-size: 80%;'>svg#radio2</text>
</svg>
</div>
```

<div style="margin-left: 30px">

```{js}
// movement function
const jump = function () {
      d3.select(this).transition().duration(500)
      .attr('y', '0')
      .transition().duration(500).ease(d3.easeBounce)
      .attr('y', '75');
};

// initial setup: add event listener to red square
d3.select("svg#radio2")
  .select("rect#red")
  .on("click", jump);
    
// switch event listeners if radio button is clicked
d3.select("div#rad2").selectAll("input")
  .on("click", function () {
  if (d3.select(this).node().value == "blue") {
    d3.select("svg#radio2").select("rect#blue").on("click", jump);
    d3.select("svg#radio2").select("rect#red").on("click", null);
    } else {
    d3.select("svg#radio2").select("rect#red").on("click", jump);
    d3.select("svg#radio2").select("rect#blue").on("click", null);
    }
});

```

</div>
